<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brand Kit Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        .drop-zone { border: 2px dashed #cbd5e0; transition: all 0.3s ease; }
        .drop-zone.active { border-color: #3b82f6; background-color: #eff6ff; }
        [x-cloak] { display: none !important; }
        /* Style range inputs */
        input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #d1d5db; border-radius: 5px; outline: none; opacity: 0.7; transition: opacity .2s; }
        input[type=range]:hover { opacity: 1; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #3b82f6; border-radius: 50%; cursor: pointer; }
        input[type=range]::-moz-range-thumb { width: 20px; height: 20px; background: #3b82f6; border-radius: 50%; cursor: pointer; border: none; }
        /* Simple toggle switch */
        .toggle-checkbox:checked { right: 0; border-color: #60a5fa; }
        .toggle-checkbox:checked + .toggle-label { background-color: #60a5fa; }
        /* Custom scrollbar for format list */
        .format-list::-webkit-scrollbar { width: 6px; }
        .format-list::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
        .format-list::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        .format-list::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Improved accessibility for focus states */
        a:focus, button:focus, input:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        
        /* Preview thumbnails for results */
        .result-thumbnail {
            position: relative;
            overflow: hidden;
            border-radius: 0.25rem;
            border: 1px solid #e5e7eb;
            width: 60px;
            height: 60px;
            margin-right: 0.5rem;
        }
        .result-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        /* Responsive tweaks */
        @media (max-width: 640px) {
            .hide-on-mobile {
                display: none;
            }
            .mobile-full-width {
                width: 100%;
            }
        }
        
        /* Animation for loading steps */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .loading-step {
            animation: fadeIn 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 via-purple-100 to-pink-100 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8" x-data="appData()" x-cloak>
        <!-- Header -->
        <header class="mb-10 text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Brand Kit Generator</h1>
            <p class="text-lg text-gray-600">Upload, customize, and generate image assets</p>
        </header>

        <!-- Main Content -->
        <main class="max-w-6xl mx-auto">
            <!-- Upload & Options Section -->
            <section
                class="mb-10 bg-white rounded-xl shadow-lg p-6 md:p-8"
                x-show="!isProcessing && !isComplete">
                <div class="flex flex-col items-center gap-8">
                    <!-- Centered Upload Area -->
                    <div class="w-full max-w-xl">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">1. Upload Image</h2>
                        <div class="flex flex-col md:flex-row items-start gap-6">
                            <!-- Drop Zone -->
                            <div
                                class="drop-zone rounded-lg p-6 text-center cursor-pointer h-64 flex flex-col justify-center items-center flex-1"
                                :class="{'active': isDragging}"
                                @dragover.prevent="isDragging = true"
                                @dragleave.prevent="isDragging = false"
                                @drop.prevent="handleDrop($event)"
                                @click="$refs.fileInput.click()">
                                <div x-show="!preview" class="text-gray-500 space-y-2">
                                    <svg x-show="!isDragging" class="w-16 h-16 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    <svg x-show="isDragging" class="w-16 h-16 mx-auto text-blue-500 animate-pulse" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /> </svg>
                                    <p class="font-semibold" x-text="isDragging ? 'Drop image here!' : 'Drag & drop or click'"></p>
                                    <p class="text-sm" x-text="isDragging ? ' ' : 'PNG, JPG, GIF, WEBP (Max {{ max_upload_mb }}MB)'"></p>
                                </div>
                                <div x-show="preview" class="relative max-h-full">
                                    <img :src="preview" x-ref="previewImg" class="max-h-48 mx-auto rounded-md shadow" @load="getImageDimensions" />
                                    <button @click.stop="resetForm()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2" aria-label="Remove image"> <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg> </button>
                                </div>
                                <input type="file" x-ref="fileInput" class="hidden" accept=".jpg,.jpeg,.png,.gif,.webp" @change="handleFileInput($event)">
                            </div>
                            <!-- File Info -->
                            <div x-show="fileInfo.name" class="text-sm text-gray-600 space-y-1 pt-2 md:pt-0 md:w-48 flex-shrink-0">
                                <p class="font-semibold text-gray-800 truncate" :title="fileInfo.name" x-text="fileInfo.name"></p>
                                <p>Type: <span class="font-medium" x-text="fileInfo.type"></span></p>
                                <p>Size: <span class="font-medium" x-text="fileInfo.size"></span></p>
                                <p x-show="fileInfo.dimensions">Dimensions: <span class="font-medium" x-text="fileInfo.dimensions"></span></p>
                            </div>
                        </div>
                        <div x-show="error" class="mt-3 text-sm text-red-600 text-center" x-text="error"></div>
                    </div>

                    <!-- Options Section Below Upload -->
                    <div class="w-full max-w-4xl mt-8 border-t pt-8">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">2. Configure Options</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                            <!-- Left Column: Preprocessing & Variations -->
                            <div class="space-y-6 flex flex-col">
                                <!-- Preprocessing Options Card -->
                                <div class="bg-gray-50 p-4 rounded-lg border shadow-sm flex-grow">
                                    <h3 class="text-lg font-medium text-gray-700 mb-3 border-b pb-2 flex items-center">
                                        <svg class="w-5 h-5 mr-2 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.395m3.42 3.42a15.995 15.995 0 004.764-4.648l3.876-5.814a1.151 1.151 0 00-1.597-1.597L14.146 6.32a15.996 15.996 0 00-4.649 4.763m3.42 3.42a6.776 6.776 0 00-3.42-3.42" /> </svg>
                                        Preprocessing
                                    </h3>
                                    <div class="grid grid-cols-2 gap-x-4 gap-y-4 text-sm pt-2">
                                        <!-- Checkboxes -->
                                        <label class="flex items-center space-x-2"><input type="checkbox" x-model="options.grayscale" class="rounded text-blue-500 focus:ring-blue-400"><span>Grayscale</span></label>
                                        <label class="flex items-center space-x-2"><input type="checkbox" x-model="options.bw" class="rounded text-blue-500 focus:ring-blue-400"><span>B&W</span></label>
                                        <label class="flex items-center space-x-2"><input type="checkbox" x-model="options.invert" class="rounded text-blue-500 focus:ring-blue-400"><span>Invert</span></label>
                                        <label class="flex items-center space-x-2"><input type="checkbox" x-model="options.enhance_contrast" class="rounded text-blue-500 focus:ring-blue-400"><span>Contrast++</span></label>
                                        <!-- Blur -->
                                        <div class="col-span-2 space-y-2 border-t pt-3 mt-1">
                                            <label class="flex items-center space-x-2"><input type="checkbox" x-model="options.apply_blur" class="rounded text-blue-500 focus:ring-blue-400"><span>Apply Blur</span></label>
                                            <div x-show="options.apply_blur" class="pl-6">
                                                <label class="block text-xs text-gray-500 mb-1" :for="'blur_radius'">Radius: <span x-text="options.blur_radius"></span></label>
                                                <input type="range" id="blur_radius" x-model="options.blur_radius" min="0.1" max="10" step="0.1">
                                            </div>
                                        </div>
                                        <!-- Hue Shift -->
                                        <div class="col-span-2 space-y-2 border-t pt-3">
                                            <label class="block text-sm text-gray-600 mb-1" :for="'hue_shift'">Hue Shift (°): <span x-text="options.hue_shift" class="font-medium text-gray-800"></span></label>
                                            <input type="range" id="hue_shift" x-model="options.hue_shift" min="-180" max="180" step="10">
                                        </div>
                                        <!-- Temperature -->
                                        <div class="col-span-2 space-y-2 border-t pt-3">
                                            <label class="block text-sm text-gray-600 mb-1" :for="'temperature'">Temperature: <span x-text="options.temperature > 0 ? '+' + options.temperature : options.temperature" class="font-medium text-gray-800"></span></label>
                                            <input type="range" id="temperature" x-model="options.temperature" min="-100" max="100" step="5">
                                        </div>
                                        <!-- Watermark -->
                                        <div class="col-span-2 space-y-2 border-t pt-3 mt-1">
                                            <label class="flex items-center space-x-2"><input type="checkbox" x-model="options.add_watermark" class="rounded text-blue-500 focus:ring-blue-400"><span>Add Watermark</span></label>
                                            <div x-show="options.add_watermark" class="pl-6 space-y-2">
                                                <input type="text" x-model="options.watermark_text" placeholder="Watermark Text" class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                                <div>
                                                    <label class="block text-xs text-gray-500 mb-1" :for="'watermark_opacity'">Opacity: <span x-text="options.watermark_opacity"></span></label>
                                                    <input type="range" id="watermark_opacity" x-model="options.watermark_opacity" min="0.1" max="1.0" step="0.05">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Smart Fill Option (Conditional) -->
                                <div x-show="analysis && analysis.has_white_area" class="bg-blue-50 p-4 rounded-lg border border-blue-200 shadow-sm">
                                    <label class="flex items-center justify-between cursor-pointer">
                                        <span class="text-lg font-medium text-gray-700 flex items-center">
                                            <svg class="w-5 h-5 mr-2 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 15l-.813.904L9.813 15.904zm-2.05-2.05L9 14.71l.86-.858L7.763 13.854zm1.39 1.39L9 15.29l.847.847L9.153 15.244zM21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 7.5a7.5 7.5 0 100-15 7.5 7.5 0 000 15z" /> </svg>
                                            Smart Background Fill?
                                        </span>
                                        <div class="relative">
                                            <input type="checkbox" x-model="fill_white_with_prominent" class="sr-only toggle-checkbox">
                                            <div class="block bg-gray-300 w-10 h-6 rounded-full"></div>
                                            <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition transform" :class="{ 'translate-x-full bg-blue-500': fill_white_with_prominent }"></div>
                                        </div>
                                    </label>
                                    <p class="text-xs text-gray-500 mt-1 pl-7">Fills transparent/white areas with a gradient based on the image's main color when resizing to non-square formats.</p>
                                    <p class="text-xs text-blue-600 mt-1 pl-7" x-text="`Detected ~${(analysis.white_area_ratio * 100).toFixed(0)}% white/transparent area.`"></p>
                                </div>

                                <!-- Variations Mode Card -->
                                <div class="bg-gray-50 p-4 rounded-lg border shadow-sm">
                                    <label class="flex items-center justify-between cursor-pointer">
                                        <span class="text-lg font-medium text-gray-700 flex items-center">
                                            <svg class="w-5 h-5 mr-2 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 16.875h3.375m0 0h3.375m-3.375 0V13.5m0 3.375v3.375M6 10.5h2.25a2.25 2.25 0 002.25-2.25V6a2.25 2.25 0 00-2.25-2.25H6A2.25 2.25 0 003.75 6v2.25A2.25 2.25 0 006 10.5zm0 9.75h2.25A2.25 2.25 0 0010.5 18v-2.25a2.25 2.25 0 00-2.25-2.25H6a2.25 2.25 0 00-2.25 2.25V18A2.25 2.25 0 006 20.25zm9.75-9.75H18a2.25 2.25 0 002.25-2.25V6A2.25 2.25 0 0018 3.75h-2.25A2.25 2.25 0 0013.5 6v2.25a2.25 2.25 0 002.25 2.25z" /> </svg>
                                            Generate Variations?
                                        </span>
                                        <div class="relative">
                                            <input type="checkbox" x-model="variations_mode" class="sr-only toggle-checkbox">
                                            <div class="block bg-gray-300 w-10 h-6 rounded-full"></div>
                                            <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition transform" :class="{ 'translate-x-full bg-blue-500': variations_mode }"></div>
                                        </div>
                                    </label>
                                    <p class="text-xs text-gray-500 mt-1 pl-7">Generates multiple versions (grayscale, inverted, etc.) for each selected format.</p>
                                </div>
                            </div>

                            <!-- Right Column: Formats & Output Types -->
                            <div class="space-y-6 flex flex-col">
                                <!-- Format Selection Card -->
                                <div class="space-y-3 bg-gray-50 p-4 rounded-lg border shadow-sm flex-grow">
                                     <div class="flex justify-between items-center mb-2 border-b pb-2">
                                         <h3 class="text-lg font-medium text-gray-700 flex items-center">
                                             <svg class="w-5 h-5 mr-2 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /> </svg>
                                             Select Formats
                                         </h3>
                                         <div class="flex space-x-2">
                                             <button type="button" @click="selectAllFormats()" class="text-xs text-blue-600 hover:text-blue-800">All</button>
                                             <button type="button" @click="clearAllFormats()" class="text-xs text-gray-500 hover:text-gray-700">None</button>
                                         </div>
                                     </div>
                                     <!-- Group formats by category -->
                                     <div class="space-y-3 max-h-80 overflow-y-auto pr-2 pt-2 format-list">
                                        <template x-for="(categoryFormats, categoryName) in groupedFormats" :key="categoryName">
                                            <div class="pt-2">
                                                <h4 class="text-sm font-semibold text-gray-600 mb-1" x-text="categoryName"></h4>
                                                <div class="grid grid-cols-2 gap-x-4 gap-y-1 pl-2">
                                                    <template x-for="formatKey in categoryFormats" :key="formatKey">
                                                        <label class="flex items-center space-x-2 group cursor-pointer text-sm" :title="`${config.formats[formatKey].description} (${config.formats[formatKey].width}x${config.formats[formatKey].height})`">
                                                            <input type="checkbox" :value="formatKey" x-model="selected_formats" class="rounded text-blue-500 focus:ring-blue-400">
                                                            <span class="capitalize group-hover:text-blue-600" x-text="formatKey.replace(/_/g, ' ')"></span>
                                                        </label>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                        <!-- Ungrouped formats (if any) -->
                                        <div x-show="ungroupedFormats.length > 0" class="pt-2">
                                             <h4 class="text-sm font-semibold text-gray-600 mb-1">Other</h4>
                                             <div class="grid grid-cols-2 gap-x-4 gap-y-1 pl-2">
                                                 <template x-for="formatKey in ungroupedFormats" :key="formatKey">
                                                     <label class="flex items-center space-x-2 group cursor-pointer text-sm" :title="`${config.formats[formatKey].description} (${config.formats[formatKey].width}x${config.formats[formatKey].height})`">
                                                         <input type="checkbox" :value="formatKey" x-model="selected_formats" class="rounded text-blue-500 focus:ring-blue-400">
                                                         <span class="capitalize group-hover:text-blue-600" x-text="formatKey.replace(/_/g, ' ')"></span>
                                                     </label>
                                                 </template>
                                             </div>
                                        </div>
                                     </div>
                                </div>

                                <!-- Output File Types Card -->
                                <div class="space-y-3 bg-gray-50 p-4 rounded-lg border shadow-sm">
                                     <h3 class="text-lg font-medium text-gray-700 mb-3 border-b pb-2 flex items-center">
                                         <svg class="w-5 h-5 mr-2 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M9 13.5l3 3m0 0l3-3m-3 3v-6m1.06-4.19l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" /> </svg>
                                         Output File Types
                                     </h3>
                                     <div class="flex flex-wrap gap-x-6 gap-y-3 text-sm pt-2">
                                        <template x-for="format in config.output_formats" :key="format">
                                             <label class="flex items-center space-x-2 cursor-pointer">
                                                 <input type="checkbox" :value="format" x-model="output_formats" :disabled="format === 'ico' && !selected_formats.includes('favicon')" class="rounded text-blue-500 focus:ring-blue-400 disabled:opacity-50 disabled:cursor-not-allowed">
                                                 <span :class="{'text-gray-400': format === 'ico' && !selected_formats.includes('favicon')}" x-text="format.toUpperCase()"></span>
                                             </label>
                                        </template>
                                     </div>
                                     <p x-show="!selected_formats.includes('favicon') && output_formats.includes('ico')" class="text-xs text-orange-600 pt-2">ICO format requires 'Favicon' format to be selected.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Submit Button -->
                <div class="mt-10 pt-6 border-t text-center">
                    <button
                        @click="uploadImage()"
                        :disabled="!file || isProcessing || selected_formats.length === 0 || output_formats.length === 0"
                        :class="{
                            'bg-blue-600 hover:bg-blue-700': file && !isProcessing && selected_formats.length > 0 && output_formats.length > 0,
                            'bg-gray-400 cursor-not-allowed': !file || isProcessing || selected_formats.length === 0 || output_formats.length === 0
                        }"
                        class="px-8 py-3 rounded-lg text-white font-semibold text-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 transition duration-150 ease-in-out shadow-md">
                        Generate Brand Kit
                    </button>
                     <p x-show="selected_formats.length === 0" class="text-sm text-red-600 mt-2">Please select at least one format to generate.</p>
                     <p x-show="output_formats.length === 0" class="text-sm text-red-600 mt-2">Please select at least one output file type.</p>
                </div>
            </section>
            <!-- Processing Section -->
            <section
                class="mb-10 bg-white rounded-xl shadow-lg p-8"
                x-show="isProcessing">
                <svg class="animate-spin h-12 w-12 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-xl text-gray-700 font-semibold">Generating your assets...</p>
                
                <!-- Show processing steps -->
                <div class="mt-4 max-w-md mx-auto text-left">
                    <div class="text-sm text-gray-600">
                        <div class="loading-step flex items-center space-x-2">
                            <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            <span>Processing image...</span>
                        </div>
                        <div x-show="variations_mode" class="loading-step flex items-center space-x-2 mt-1">
                            <svg class="w-4 h-4 text-blue-500 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0115.357 2m0 0H15"></path></svg>
                            <span>Generating variations...</span>
                        </div>
                        <div class="loading-step flex items-center space-x-2 mt-1">
                            <svg class="w-4 h-4 text-blue-500 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"></path></svg>
                            <span>Resizing to <span x-text="selected_formats.length"></span> formats...</span>
                        </div>
                        <div class="loading-step flex items-center space-x-2 mt-1">
                            <svg class="w-4 h-4 text-blue-500 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                            <span>Creating output files...</span>
                        </div>
                    </div>
                </div>
                
                <p class="mt-4 text-sm text-gray-500">This might take a moment, especially for variations and larger images.</p>
                
                <!-- Add a cancel option -->
                <button 
                    @click="isProcessing = false; error = 'Processing cancelled by user.'; isComplete = true;"
                    class="mt-6 text-sm text-red-600 hover:text-red-800 underline">
                    Cancel processing
                </button>
            </section>

            <!-- Results Section -->
            <section
                class="bg-white rounded-xl shadow-lg p-6 md:p-8"
                x-show="isComplete">
                <!-- Results Header with Prominent Download All Button -->
                <div class="flex flex-col items-center justify-center mb-8">
                    <h2 class="text-2xl font-bold text-gray-700 mb-5">Your Brand Kit is Ready!</h2>
                    
                    <!-- Prominent Download ZIP Button -->
                    <div x-show="results && results.zip" class="w-full max-w-md mb-6">
                        <a :href="results.zip.url" 
                           :download="results.zip.filename"
                           class="flex items-center justify-center w-full px-6 py-4 text-lg font-semibold text-white bg-green-600 rounded-lg shadow-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                            <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Download All Assets (.zip)
                        </a>
                        <p class="text-center text-sm text-gray-500 mt-2">Contains all generated images in a single package</p>
                    </div>
                    
                    <!-- Start Over Button -->
                    <button
                        @click="resetForm()"
                        class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0115.357 2m0 0H15" />
                        </svg>
                        Start Over
                    </button>
                </div>

                <!-- Display Error if processing failed but completed flag is set -->
                <div x-show="error && isComplete" class="mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-md">
                    <p class="font-bold">Processing Error:</p>
                    <p x-text="error"></p>
                </div>

                <!-- Results Tabs -->
                <div x-show="results && !error" x-data="{ activeTab: 'formats' }" class="mb-8">
                    <div class="border-b border-gray-200">
                        <nav class="flex space-x-8">
                            <button 
                                @click="activeTab = 'formats'" 
                                :class="{'border-blue-500 text-blue-600': activeTab === 'formats', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'formats'}" 
                                class="py-2 px-1 border-b-2 font-medium text-sm focus:outline-none">
                                Generated Assets
                            </button>
                            <button 
                                @click="activeTab = 'original'" 
                                :class="{'border-blue-500 text-blue-600': activeTab === 'original', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'original'}" 
                                class="py-2 px-1 border-b-2 font-medium text-sm focus:outline-none">
                                Original Image
                            </button>
                        </nav>
                    </div>

                    <!-- Original Image Tab Content -->
                    <div x-show="activeTab === 'original'" class="pt-4 pb-2">
                        <div x-show="results.original" class="bg-gray-50 rounded-lg p-4 border flex flex-col items-center">
                            <h3 class="text-lg font-medium text-gray-800 mb-2">Original Uploaded Image</h3>
                            <div class="max-w-xs mb-3">
                                <img :src="results.original.url" class="object-contain rounded-md shadow-sm" />
                            </div>
                            <a :href="results.original.url" download class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Download Original
                            </a>
                        </div>
                    </div>

                    <!-- Generated Assets Tab Content -->
                    <div x-show="activeTab === 'formats'" class="pt-4 space-y-6">
                        <!-- Favicon (always display if available) -->
                        <div x-show="results.favicon_ico" class="bg-gray-50 rounded-lg p-4 border">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-medium text-gray-800">Favicon (.ico)</h3>
                                <a :href="results.favicon_ico.url" download="favicon.ico" class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Download favicon.ico
                                </a>
                            </div>
                            <div class="mt-2">
                                <img :src="results.favicon_ico.url" class="w-12 h-12 object-contain border rounded bg-white p-1" alt="Favicon Preview"/>
                            </div>
                        </div>

                        <!-- Variations Display -->
                        <div x-show="results && results.variations" class="bg-white rounded-lg border">
                            <div class="bg-gray-50 p-3 border-b rounded-t-lg">
                                <h3 class="text-xl font-semibold text-gray-800">Generated Variations</h3>
                                <p class="text-xs text-gray-500">Multiple versions of each format were created based on your settings</p>
                            </div>
                            <div class="p-4 space-y-6">
                                <template x-for="(variationData, variationLabel) in results.variations" :key="variationLabel">
                                    <div class="bg-gray-50 rounded-lg p-4 border">
                                        <h4 class="text-lg font-medium text-gray-700 mb-3 capitalize" x-text="variationLabel.replace(/_/g, ' ')"></h4>
                                        <!-- Two-column layout for format details -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3">
                                            <template x-for="(formatData, formatName) in variationData" :key="formatName">
                                                <div class="bg-white p-3 rounded border border-gray-200 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                                                    <div class="mb-2 sm:mb-0 mr-2">
                                                        <p class="text-sm font-semibold text-gray-700 capitalize" x-text="formatName.replace(/_/g, ' ')"></p>
                                                        <p class="text-xs text-gray-500" x-text="formatData.description"></p>
                                                    </div>
                                                    <!-- Dimensions and Download Buttons -->
                                                    <div class="flex flex-wrap items-center gap-2 shrink-0">
                                                        <span class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-700 whitespace-nowrap" x-text="`${formatData.dimensions[0]}×${formatData.dimensions[1]}`"></span>
                                                        <template x-for="(outputData, outputFormat) in formatData.outputs" :key="outputFormat">
                                                            <a :href="outputData.url" download :download="`${variationLabel}_${formatName}.${outputFormat}`"
                                                               class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-700 hover:bg-blue-200 hover:text-blue-800 whitespace-nowrap transition">
                                                               .<span x-text="outputFormat"></span>
                                                            </a>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Standard (Non-Variations) Display -->
                        <div x-show="results && !results.variations" class="bg-white rounded-lg border">
                            <div class="bg-gray-50 p-3 border-b rounded-t-lg">
                                <h3 class="text-xl font-semibold text-gray-800">Generated Formats</h3>
                                <p class="text-xs text-gray-500">Standard formats created from your image</p>
                            </div>
                            <div class="p-4">
                                <!-- Two-column layout for format details -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                    <template x-for="(formatData, formatName) in results" :key="formatName">
                                        <div x-show="!['original', 'zip', 'variations', 'favicon_ico', 'analysis'].includes(formatName)" 
                                             class="bg-gray-50 rounded-lg p-3 border border-gray-200 hover:border-blue-200 hover:shadow-md transition duration-150">
                                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                                                <div class="flex items-center mb-2 sm:mb-0 mr-2">
                                                    <!-- Add thumbnail preview -->
                                                    <div class="result-thumbnail hide-on-mobile">
                                                        <template x-for="(outputData, outputFormat) in formatData.outputs" :key="outputFormat">
                                                            <img x-show="outputFormat === Object.keys(formatData.outputs)[0]" :src="outputData.url" alt="" />
                                                        </template>
                                                    </div>
                                                    <div>
                                                        <p class="text-sm font-semibold text-gray-700 capitalize" x-text="formatName.replace(/_/g, ' ')"></p>
                                                        <p class="text-xs text-gray-500" x-text="formatData.description"></p>
                                                    </div>
                                                </div>
                                                <!-- Dimensions and Download Buttons -->
                                                <div class="flex flex-wrap items-center gap-2 shrink-0">
                                                    <span class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-700 whitespace-nowrap" x-text="`${formatData.dimensions[0]}×${formatData.dimensions[1]}`"></span>
                                                    <template x-for="(outputData, outputFormat) in formatData.outputs" :key="outputFormat">
                                                        <a :href="outputData.url" download :download="`${formatName}.${outputFormat}`"
                                                           class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-700 hover:bg-blue-200 hover:text-blue-800 whitespace-nowrap transition">
                                                           .<span x-text="outputFormat"></span>
                                                        </a>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bottom Download All Button -->
                <div x-show="results && results.zip" class="mt-8 text-center">
                    <a :href="results.zip.url" 
                       :download="results.zip.filename"
                       class="inline-flex items-center px-4 py-2 text-base font-medium text-white bg-green-600 rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Download All (.zip)
                    </a>
                </div>
            </section>
        </main>
    </div>

    <script>
        function appData() {
            // Get config from server-side template
            const initialConfig = {{ config|tojson }};
            const max_upload_mb = {{ max_upload_mb|tojson }};
            
            // Constants for default selections
            const defaultFormats = ['webapp', 'social', 'favicon'];
            const defaultOutputFormats = ['png', 'jpg'];
            
            // Format groups for better UI organization
            const groupedFormats = {};
            const ungroupedFormats = [];
            
            // Process formats into groups
            for (const formatKey in initialConfig.formats) {
                let categoryFound = false;
                for (const category in initialConfig.format_categories || {}) {
                    if (initialConfig.format_categories[category].includes(formatKey)) {
                        if (!groupedFormats[category]) {
                            groupedFormats[category] = [];
                        }
                        groupedFormats[category].push(formatKey);
                        categoryFound = true;
                        break;
                    }
                }
                if (!categoryFound) {
                    ungroupedFormats.push(formatKey);
                }
            }
            
            return {
                config: initialConfig,
                file: null,
                preview: null,
                isDragging: false,
                isProcessing: false,
                isComplete: false,
                error: null,
                results: null,
                max_upload_mb: max_upload_mb,
                groupedFormats: groupedFormats,
                ungroupedFormats: ungroupedFormats,
                fileInfo: {
                    name: '',
                    type: '',
                    size: '',
                    dimensions: ''
                },
                // --- Intelligence ---
                analysis: null, // Holds prominent color/white area info
                fill_white_with_prominent: false, // User option
                // --- End Intelligence ---
                // --- Options ---
                options: {
                    grayscale: false,
                    bw: false,
                    invert: false,
                    hue_shift: 0,
                    temperature: 0,
                    enhance_contrast: false,
                    apply_blur: false,
                    blur_radius: 2.0,
                    add_watermark: false,
                    watermark_text: '© BrandKit',
                    watermark_opacity: 0.3,
                },
                selected_formats: [...defaultFormats], // Default select all formats
                output_formats: [...defaultOutputFormats], // Default select common formats
                variations_mode: false,
                // --- End Options ---

                init() {
                    // Add 'ico' to output formats if 'favicon' is initially selected
                    if (this.selected_formats.includes('favicon')) {
                        if (!this.output_formats.includes('ico')) {
                            this.output_formats.push('ico');
                        }
                    }
                    // Watch for changes in selected_formats to manage 'ico' output option
                    this.$watch('selected_formats', (newFormats) => {
                        const icoIndex = this.output_formats.indexOf('ico');
                        if (newFormats.includes('favicon')) {
                            // If favicon is selected, ensure ico is an option (if available in config)
                            if (icoIndex === -1 && this.config.output_formats.includes('ico')) {
                                this.output_formats.push('ico');
                            }
                        } else {
                            // If favicon is deselected, remove ico from selected outputs
                            if (icoIndex !== -1) {
                                this.output_formats.splice(icoIndex, 1);
                            }
                        }
                    });
                    // Watch output formats to ensure ico isn't selected without favicon
                    this.$watch('output_formats', (newOutputs) => {
                        if (newOutputs.includes('ico') && !this.selected_formats.includes('favicon')) {
                            const icoIndex = this.output_formats.indexOf('ico');
                            if (icoIndex !== -1) {
                                // This case should be prevented by disabling the checkbox, but as a fallback:
                                this.output_formats.splice(icoIndex, 1);
                                console.warn("ICO output format automatically deselected because Favicon format is not chosen.");
                            }
                        }
                    });
                },

                getImageDimensions() {
                    if (this.$refs.previewImg && this.$refs.previewImg.complete) {
                        const width = this.$refs.previewImg.naturalWidth;
                        const height = this.$refs.previewImg.naturalHeight;
                        this.fileInfo.dimensions = `${width}x${height}`;
                    }
                },

                handleDrop(e) {
                    this.isDragging = false;
                    this.error = null; // Clear previous error
                    const droppedFiles = e.dataTransfer.files;
                    if (droppedFiles.length > 0) {
                        this.handleFile(droppedFiles[0]);
                    }
                },

                handleFileInput(e) {
                     this.error = null; // Clear previous error
                    const files = e.target.files;
                    if (files.length > 0) {
                        this.handleFile(files[0]);
                    }
                },

                handleFile(file) {
                    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                    if (!validTypes.includes(file.type)) {
                        this.error = 'Invalid file type. Please use JPG, PNG, GIF, or WEBP.';
                        this.resetFileInput();
                        return;
                    }
                    if (file.size > this.max_upload_mb * 1024 * 1024) {
                         this.error = `File is too large (Max ${this.max_upload_mb}MB).`;
                         this.resetFileInput();
                        return;
                    }
                    this.file = file;
                    this.createPreview(file);
                    
                    // Update file info
                    this.fileInfo.name = file.name;
                    this.fileInfo.type = file.type.replace('image/', '').toUpperCase();
                    this.fileInfo.size = this.formatFileSize(file.size);
                    
                    // After successfully handling the file, analyze it
                    this.analyzeUploadedImage();
                },

                formatFileSize(bytes) {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                },

                createPreview(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => { this.preview = e.target.result; };
                    reader.onerror = () => { this.error = "Could not read file preview."; };
                    reader.readAsDataURL(file);
                },

                resetFileInput() {
                    this.file = null;
                    this.preview = null;
                    this.fileInfo = {name: '', type: '', size: '', dimensions: ''};
                    if (this.$refs.fileInput) {
                        this.$refs.fileInput.value = '';
                    }
                },

                resetForm() {
                    this.resetFileInput();
                    this.isProcessing = false;
                    this.isComplete = false;
                    this.error = null;
                    this.results = null;
                    this.analysis = null;
                    // Reset options to defaults
                    this.options = { 
                        grayscale: false, 
                        bw: false, 
                        invert: false, 
                        hue_shift: 0, 
                        temperature: 0, 
                        enhance_contrast: false, 
                        apply_blur: false, 
                        blur_radius: 2.0, 
                        add_watermark: false, 
                        watermark_text: '© BrandKit', 
                        watermark_opacity: 0.3 
                    };
                    this.selected_formats = [...defaultFormats];
                    this.output_formats = [...defaultOutputFormats];
                    if (this.selected_formats.includes('favicon') && !this.output_formats.includes('ico') && this.config.output_formats.includes('ico')) {
                        this.output_formats.push('ico');
                    }
                    this.variations_mode = false;
                    this.fill_white_with_prominent = false;
                },

                selectAllFormats() {
                    this.selected_formats = Object.keys(this.config.formats || {});
                },

                clearAllFormats() {
                    this.selected_formats = [];
                },

                analyzeUploadedImage() {
                    if (!this.file) return;
                    
                    // Create a form data object
                    const formData = new FormData();
                    formData.append('file', this.file);
                    
                    // Show a subtle loading indicator
                    this.analysis = { analyzing: true };
                    
                    // Make the analysis request
                    fetch('/analyze', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            this.analysis = data.analysis;
                            
                            // Auto-enable smart fill if significant white area detected
                            if (data.analysis.has_white_area && data.analysis.white_area_ratio > 0.3) {
                                this.fill_white_with_prominent = true;
                            }
                        } else {
                            console.warn('Image analysis failed:', data.error);
                            this.analysis = null;
                        }
                    })
                    .catch(err => {
                        console.error('Error analyzing image:', err);
                        this.analysis = null;
                    });
                },

                uploadImage() {
                    if (!this.file || this.selected_formats.length === 0 || this.output_formats.length === 0) return;

                    this.isProcessing = true;
                    this.isComplete = false; // Ensure results aren't shown during processing
                    this.error = null; // Clear previous errors
                    this.results = null; // Clear previous results

                    // Show a processing estimate
                    let estimatedTime = "a few seconds";
                    if (this.variations_mode) {
                        estimatedTime = "up to a minute";
                        if (this.selected_formats.length > 10) {
                            estimatedTime = "several minutes";
                        }
                    } else if (this.selected_formats.length > 10) {
                        estimatedTime = "about a minute";
                    }
                    console.log(`Processing estimate: ${estimatedTime}`);

                    const formData = new FormData();
                    formData.append('file', this.file);

                    // Append options
                    Object.entries(this.options).forEach(([key, value]) => {
                        formData.append(key, value);
                    });

                    // Append selected formats and output formats
                    this.selected_formats.forEach(format => formData.append('selected_formats', format));
                    this.output_formats.forEach(format => formData.append('output_formats', format));

                    // Append variations mode and smart fill option
                    formData.append('variations_mode', this.variations_mode);
                    formData.append('fill_white_with_prominent', this.fill_white_with_prominent);

                    fetch('/upload', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(errData => {
                                throw new Error(errData.error || `HTTP error ${response.status}`);
                            }).catch(parseErr => {
                                throw new Error(`HTTP error ${response.status}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            this.results = data.results;
                            this.analysis = data.results.analysis || null;
                            this.isComplete = true;
                            
                            // Track metrics (could be sent to a server)
                            const metrics = {
                                formats: this.selected_formats.length,
                                variations: this.variations_mode,
                                outputTypes: this.output_formats.length,
                                imageSize: this.fileInfo.size,
                                processingOptions: Object.entries(this.options).filter(([_, v]) => v).map(([k]) => k)
                            };
                            console.log('Generation metrics:', metrics);
                        } else {
                            this.error = data.error || 'An unknown error occurred during processing.';
                            this.isComplete = true;
                        }
                    })
                    .catch(error => {
                        console.error('Upload Error:', error);
                        this.error = error.message || 'Network error or server issue. Please try again.';
                        this.isComplete = true;
                    })
                    .finally(() => {
                        this.isProcessing = false;
                    });
                }
            }
        }
    </script>
</body>
</html>